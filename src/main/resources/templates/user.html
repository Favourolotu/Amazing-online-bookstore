<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Amazing Bookstore</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <!-- <script type="application/javascript" src="/script.js"></script>-->

  <script>
    function showOption(){
      const input = document.getElementById("searchedItem");
      const filter = input.value.toUpperCase();
      const table = document.querySelector("table");
      const tr = table.getElementsByTagName("tr");

      // Loop through all table rows, and hide those who don't match the search query
      for (let i = 0; i < tr.length; i++) {
        const authorData = tr[i].getElementsByTagName("td")[2];
        const publisherData = tr[i].getElementsByTagName("td")[4];
        if (authorData || publisherData) {
          const txtValue = authorData.textContent || authorData.innerText;
          const txtValue2 = publisherData.textContent || authorData.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1 || txtValue2.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }

    function sort(table, column, asc =true){
      const dirModifier = asc ? 1 : -1;
      const tBody = table.tBodies[0];
      const rows = Array.from(tBody.querySelectorAll('tr'));

      //sort rows
      const sortedRows = rows.sort((a, b) =>{
        const aColText = a.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
        const bColText = b.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();

        return aColText > bColText ? (1*dirModifier) : (-1*dirModifier)
      })

      //clear out table
      while (tBody.firstChild){
        tBody.removeChild(tBody.firstChild);
      }

      //re-add sorted rows
      tBody.append(...sortedRows);
    }

    function sortTable(){
      let sortOption = $('#sortOption option:selected').text();

      if(sortOption == 'Title'){
        sort(document.querySelector('table'), 1);
      }
      else if(sortOption == 'Author'){
        sort(document.querySelector('table'), 2);
      }
      else if(sortOption == 'Description'){
        sort(document.querySelector('table'), 3);
      }
      else if(sortOption == 'Publisher'){
        sort(document.querySelector('table'), 4);
      }
      else if(sortOption == 'Stock'){
        sort(document.querySelector('table'), 5);
      }else{
        sort(document.querySelector('table'), 0);
      }

    }
  </script>
</head>
<body>

<h1 th:inline="text">User: [[${username}]]</h1>

<h1>Welcome to The Amazing Online Bookstore</h1>
<br>

<label>Sort By:</label>
<select id="sortOption">
  <option value="ISBN">ISBN</option>
  <option value="Title">Title</option>
  <option value="Author">Author</option>
  <option value="Description">Description</option>
  <option value="Publisher">Publisher</option>
  <option value="Stock">Stock</option>
</select>
<button type="button" id="sortButton" onclick="sortTable()">Select option</button>

<br>
<br>

<label>Filter By: </label>
<input type="text" id="searchedItem" placeholder="Search author or publisher..." onkeyup="showOption()"/>

<br>
<br>

<table>
  <thead>
  <tr>
    <th>ISBN</th>
    <th>Title</th>
    <th>Author</th>
    <th>Description</th>
    <th>Publisher</th>
    <th>Stock</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="book : ${books}">
    <td th:text="${book.ISBN}"></td>
    <td th:text="${book.title}"></td>
    <td th:text="${book.author}"></td>
    <td th:text="${book.description}"></td>
    <td th:text="${book.publisher}"></td>
    <td th:text="${book.stock}"></td>

    <td>
      <form th:action="@{/user/{username}/addToCart(username=${username})}" th:object="${book}" th:method="post">

        <input type="hidden" id="bookISBN" name="bookISBN" th:value="${book.ISBN}">
        <input type="hidden" id="username" name="username" th:value="${username}">

        <input type="hidden" id="title" name="title" th:value="${book.title}" required>

        <input type="hidden" id="author" name="author" th:value="${book.author}" required>

        <input type="hidden" id="description" name="description" th:value="${book.description}" required>

        <input type="hidden" id="publisher" name="publisher" th:value="${book.publisher}" required>

        <label for="stock">Quantity:</label>
        <input type="number" min="1" max="4" id="stock" name="stock" th:value="1" required>

        <input type="submit" value="Add to Cart">
      </form>
    </td>

  </tr>
  </tbody>
</table>

<form action="#" th:action="@{/user/{username}/search(username=${username})}" method="get">
  <p>Input Book Name: <input type="text" name="bookName"/>  <input type="submit" value="Search for Book" /></p>
</form>

<form action="#" th:action="@{/user/{username}/viewCart(username=${username})}" method="get">
  <p><input type="submit" value="View Shopping Cart" /></p>
</form>


<hr>
<form action="#" th:action="@{/logout}" method="get">
  <p><input type="submit" value="Logout" /></p>
</form>


</body>
</html>